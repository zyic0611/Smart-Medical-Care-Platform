version: '3.8'

services:
  # 1. Minio (å¯¹è±¡å­˜å‚¨è¿˜æ˜¯å»ºè®®ç”¨ Docker è·‘ï¼Œæ–¹ä¾¿)
  minio:
    image: minio/minio
    container_name: medical-minio
    ports:
      - "9000:9000"
      - "9001:9001"
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin
    command: server /data --console-address ":9001"
    volumes:
      - minio-data:/data

  # 2. åç«¯ SpringBoot
  backend:
    build: ./backend
    container_name: medical-backend
    ports:
      - "9090:9090"  # --- ä¿®æ”¹ç‚¹ï¼šç«¯å£æ”¹æˆ 9090 ---
    depends_on:
      - minio        # ä¸éœ€è¦ depend MySQL äº†ï¼Œå› ä¸ºå®ƒåœ¨å¤–é¢
    environment:
      # --- å…³é”®ä¿®æ”¹ç‚¹ ---
      # 1. åœ°å€å¿…é¡»å†™ host.docker.internalï¼Œè¿™ä»£è¡¨ä½ çš„ Mac æœ¬æœº
      SPRING_DATASOURCE_URL: jdbc:mysql://host.docker.internal:3306/medical_db?useSSL=false&serverTimezone=UTC&allowPublicKeyRetrieval=true
      # 2. å¡«ä½ æœ¬æœº MySQL çš„è´¦å·å¯†ç 
      SPRING_DATASOURCE_USERNAME: root
      SPRING_DATASOURCE_PASSWORD: 123
      # 3. Minio é…ç½®
      MINIO_ENDPOINT: http://minio:9000
    profiles: ["app-only"]



  # 3. å‰ç«¯ Vue
  frontend:
    build: ./frontend
    container_name: medical-frontend
    ports:
      - "80:80"
    depends_on:
      - backend
    profiles: ["app-only"]

  db:
    image: mysql:8.0
    container_name: medical-mysql
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: smart_medical  # å¯åŠ¨æ—¶è‡ªåŠ¨åˆ›å»ºä¸€ä¸ªåº“
    ports:
      - "3306:3306"
    volumes:
      - ./mysql_data:/var/lib/mysql  # ã€æ•°æ®å·ã€‘æŠŠæ•°æ®åº“æ–‡ä»¶å­˜åœ¨ä½ é¡¹ç›®ä¸‹çš„ mysql_data æ–‡ä»¶å¤¹é‡Œ

  redis:
    image: redis:latest
    container_name: smartmedical-redis
    ports:
      - "6379:6379"
    restart: always

  rabbitmq:
    image: rabbitmq:3.12-management
    container_name: medical-mq
    restart: always
    ports:
      - "5672:5672"   # ä»£ç è¿æ¥ç«¯å£
      - "15672:15672" # ç½‘é¡µç®¡ç†ç•Œé¢ç«¯å£
    environment:
      RABBITMQ_DEFAULT_USER: guest
      RABBITMQ_DEFAULT_PASS: guest

  nginx-proxy:
    image: nginx:alpine  # è½»é‡ç‰ˆNginxé•œåƒ
    ports:
      - "9090:80"  # æ ¸å¿ƒæ˜ å°„ï¼šå®¿ä¸»æœº9090ç«¯å£ â†’ å®¹å™¨80ç«¯å£
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf  # æŒ‚è½½è‡ªå®šä¹‰é…ç½®
    restart: always  # å®¹å™¨å¼‚å¸¸é€€å‡ºè‡ªåŠ¨é‡å¯


  ai-worker:
    # ğŸŒŸ å…³é”®ä¿®æ”¹ï¼šå‘Šè¯‰ Docker å» python ç›®å½•æ‰¾ Dockerfile
    build: ./ai_work
    image: medical-ai-server:v1
    container_name: medical_ai_worker
    restart: always
    command: python medical_ai_api.py
    volumes:
      # ğŸŒŸ æŒ‚è½½è·¯å¾„ä¹Ÿè¦æ”¹ï¼ŒæŠŠä¸»ç›®å½•ä¸‹çš„ python æ–‡ä»¶å¤¹æ˜ å°„è¿›å»
      - ./ai_work:/app
    environment:
      - TZ=Asia/Shanghai



  # 2. ç»“æœæŸ¥è¯¢ API
  diagnosis-api:
    build: ./ai_work
    image: medical-ai-server:v1
    container_name: medical_diagnosis_api
    restart: always
    command: uvicorn diagnosis_api:app --host 0.0.0.0 --port 9091
    ports:
      - "9091:9091"
    volumes:
      - ./ai_work:/app
    environment:
      - TZ=Asia/Shanghai
      - PYTHONUNBUFFERED=1



volumes:
  minio-data: